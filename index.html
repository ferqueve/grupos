<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compartir Ubicación</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
     
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex: 1;
        }
        
        #map {
            height: 65vh;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            z-index: 1;
            border-radius: 8px;
        }
        
        .map-error {
            height: 65vh;
            background-color: #f8d7da;
            color: #721c24;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-direction: column;
            padding: 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: none;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input, textarea, button {
            padding: 12px;
            font-size: 16px;
            border-radius: 4px;
        }
        
        textarea {
            resize: vertical;
        }
        
        button {
            background-color: #25D366;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #128C7E;
        }
        
        .location-info {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        h1 {
            margin-top: 0;
            font-size: 24px;
        }
        
        #shareBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .whatsapp-icon {
            width: 20px;
            height: 20px;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            text-align: center;
        }
        
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status-message.loading {
            background-color: #e0f3ff;
            color: #004085;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Estilos para el popup del mensaje */
        .leaflet-popup-content-wrapper {
            background-color: #25D366;
            color: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 12px 16px;
            font-weight: bold;
        }
        
        .leaflet-popup-tip {
            background-color: #25D366;
        }
        
        .leaflet-popup-close-button {
            color: white;
        }
        
        /* Estilo para el texto del mensaje */
        .message-text {
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Spinner para indicar carga */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enviar ubicación e instrucciones.</h1>
        
        <div id="map"></div>
        <div id="mapError" class="map-error">
            <h3>No se pudo cargar el mapa</h3>
            <p>Aún puedes compartir tu ubicación por texto usando el botón de abajo.</p>
        </div>
        
        <div class="controls">
            <textarea id="message" placeholder="Escribe tu mensaje para mostrar sobre el marcador" rows="2">¡Nos vemos aquí!</textarea>
            <button id="updateMsgBtn">Actualizar mensaje</button>
            <button id="captureImageBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" fill="white"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9 2L7.17 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4H16.83L15 2H9ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17Z" fill="white"/>
                </svg>
                Capturar y compartir imagen
            </button>
            <button id="shareBtn">
                <svg class="whatsapp-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                    <path fill="white" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
                </svg>
                Compartir a WhatsApp
            </button>
        </div>
        
        <div class="location-info" id="locationInfo">
            Cargando ubicación...
        </div>
        
        <div id="statusMessage" class="status-message"></div>
    </div>
    
    <script>
        // Variables globales
        let map;
        let marker;
        let userMarker;
        let popup;
        let routeLine;
        let currentPosition = [20.6534, -103.3919]; // Default: Guadalajara, México
        let userPosition = [20.6534, -103.3919]; // Posición del usuario
        let mapLoaded = false;
        
        // API key de GraphHopper (gratuita)
        const GRAPHHOPPER_API_KEY = "3e2b25a9-0ecc-4c60-8227-edaa4232b385";
        
        // Función para inicializar el mapa cuando la página esté cargada
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Comprobar si Leaflet está cargado
                if (typeof L !== 'undefined') {
                    initMap();
                    mapLoaded = true;
                    document.getElementById('map').style.display = 'block';
                    document.getElementById('mapError').style.display = 'none';
                } else {
                    handleMapError();
                }
            } catch (error) {
                console.error("Error al inicializar el mapa:", error);
                handleMapError();
            }
            
            // Botón para actualizar el mensaje
            document.getElementById('updateMsgBtn').addEventListener('click', updateMessage);
            
            // Botón para compartir
            document.getElementById('shareBtn').addEventListener('click', shareToWhatsApp);
            // Botón para capturar y compartir imagen
            document.getElementById('captureImageBtn').addEventListener('click', captureAndShareMapImage);
            // Intentar obtener la ubicación actual del usuario
            if (navigator.geolocation) {
                document.getElementById('locationInfo').innerHTML = 'Obteniendo tu ubicación...';
                
                navigator.geolocation.getCurrentPosition(function(position) {
                    userPosition = [position.coords.latitude, position.coords.longitude];
                    currentPosition = [position.coords.latitude, position.coords.longitude];
                    
                    updateLocationInfo();
                    
                    if (mapLoaded && map && marker) {
                        // Update marker position
                        marker.setLatLng(currentPosition);
                        map.setView(currentPosition, 16);
                        marker.openPopup();
                        
                        // Create user marker
                        createUserMarker();
                    }
                }, function(error) {
                    console.error('Error getting location:', error);
                    document.getElementById('locationInfo').innerHTML = 
                        'No se pudo obtener tu ubicación. Toca en el mapa para colocar el marcador.';
                });
            } else {
                document.getElementById('locationInfo').innerHTML = 
                    'Tu navegador no soporta geolocalización. Toca en el mapa para colocar el marcador.';
            }
        });
        
        // Función para manejar errores del mapa
        function handleMapError() {
            console.error("Error: Leaflet no está disponible");
            document.getElementById('map').style.display = 'none';
            document.getElementById('mapError').style.display = 'flex';
            document.getElementById('locationInfo').innerHTML = 
                `Ubicación aproximada: ${currentPosition[0].toFixed(6)}, ${currentPosition[1].toFixed(6)}`;
            mapLoaded = false;
        }
        
        // Crear marcador para la ubicación del usuario
        function createUserMarker() {
            try {
                if (map && mapLoaded) {
                    // Crear icono personalizado para el usuario (azul)
                    const userIcon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                        shadowSize: [41, 41]
                    });
                    
                    // Si ya existe un marcador de usuario, eliminarlo
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    // Crear nuevo marcador para el usuario
                    userMarker = L.marker(userPosition, {
                        icon: userIcon
                    }).addTo(map);
                    
                    userMarker.bindPopup("Tu ubicación actual");
                    
                    // Dibujar ruta si el destino es diferente a la ubicación del usuario
                    if (currentPosition[0] !== userPosition[0] || currentPosition[1] !== userPosition[1]) {
                        drawRoute();
                    }
                }
            } catch (error) {
                console.error("Error al crear marcador de usuario:", error);
            }
        }
        
        // Dibujar ruta entre la ubicación del usuario y el destino
        function drawRoute() {
            try {
                if (map && mapLoaded) {
                    // Limpiar ruta anterior si existe
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    
                    // Mostrar mensaje de carga
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.innerHTML = '<div class="spinner"></div> Calculando ruta...';
                    statusMessage.className = 'status-message loading';
                    
                    // Obtener la ruta desde GraphHopper
                    const url = `https://graphhopper.com/api/1/route?point=${userPosition[0]},${userPosition[1]}&point=${currentPosition[0]},${currentPosition[1]}&vehicle=car&locale=es&calc_points=true&key=${GRAPHHOPPER_API_KEY}`;
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.paths && data.paths.length > 0) {
                                const path = data.paths[0];
                                
                                // Decodificar puntos de la ruta
                                const points = decodePolyline(path.points);
                                
                                // Crear línea de la ruta
                                routeLine = L.polyline(points, {
                                    color: '#0080ff',
                                    weight: 5,
                                    opacity: 0.7
                                }).addTo(map);
                                
                                // Ajustar vista para mostrar toda la ruta
                                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                                
                                // Actualizar información con la distancia de la ruta
                                const distanceKm = (path.distance / 1000).toFixed(2);
                                updateLocationInfo(distanceKm);
                                
                                // Ocultar mensaje de carga
                                statusMessage.className = 'status-message';
                            } else {
                                console.error("Error en respuesta de GraphHopper:", data);
                                
                                // Dibujar línea recta como fallback
                                drawStraightLine();
                                
                                // Mostrar mensaje de error
                                statusMessage.textContent = 'No se pudo calcular la ruta detallada. Mostrando línea recta.';
                                statusMessage.className = 'status-message error';
                                
                                // Ocultar mensaje después de 3 segundos
                                setTimeout(() => {
                                    statusMessage.className = 'status-message';
                                }, 3000);
                            }
                        })
                        .catch(error => {
                            console.error("Error obteniendo ruta:", error);
                            
                            // Dibujar línea recta como fallback
                            drawStraightLine();
                            
                            // Mostrar mensaje de error
                            statusMessage.textContent = 'Error al calcular la ruta. Mostrando línea recta.';
                            statusMessage.className = 'status-message error';
                            
                            // Ocultar mensaje después de 3 segundos
                            setTimeout(() => {
                                statusMessage.className = 'status-message';
                            }, 3000);
                        });
                }
            } catch (error) {
                console.error("Error al dibujar ruta:", error);
                
                // Dibujar línea recta como fallback
                drawStraightLine();
            }
        }
        
        // Función para decodificar polyline de GraphHopper
        function decodePolyline(encoded) {
            // Array that will contain the points
            var points = [];
            var index = 0, len = encoded.length;
            var lat = 0, lng = 0;
            
            while (index < len) {
                var b, shift = 0, result = 0;
                
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                var dlat = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                
                shift = 0;
                result = 0;
                
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                var dlng = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                
                points.push([lat * 1e-5, lng * 1e-5]);
            }
            
            return points;
        }
        
        // Dibujar línea recta entre la ubicación del usuario y el destino (fallback)
        function drawStraightLine() {
            try {
                if (map && mapLoaded) {
                    // Limpiar ruta anterior si existe
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    
                    // Crear línea recta
                    routeLine = L.polyline([userPosition, currentPosition], {
                        color: '#ff4040',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(map);
                    
                    // Ajustar vista para mostrar toda la línea
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                }
            } catch (error) {
                console.error("Error al dibujar línea recta:", error);
            }
        }
        
        // Initialize the map
        function initMap() {
            try {
                // Create map
                map = L.map('map').setView(currentPosition, 15);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Obtener el mensaje inicial
                const initialMessage = document.getElementById('message').value;
                
                // Create popup with initial message
                popup = L.popup({
                    closeButton: false,
                    autoClose: false,
                    closeOnEscapeKey: false,
                    closeOnClick: false
                }).setContent('<div class="message-text">' + initialMessage + '</div>');
                
                // Create marker with popup
                marker = L.marker(currentPosition, {
                    draggable: true
                }).addTo(map).bindPopup(popup).openPopup();
                
                // Update marker position when dragged
                marker.on('dragend', function() {
                    currentPosition = [marker.getLatLng().lat, marker.getLatLng().lng];
                    updateLocationInfo();
                    marker.openPopup();
                    
                    // Dibujar ruta si la ubicación del usuario está disponible
                    if (userMarker) {
                        drawRoute();
                    }
                });
                
                // Update marker position when map is clicked
                map.on('click', function(e) {
                    currentPosition = [e.latlng.lat, e.latlng.lng];
                    marker.setLatLng(e.latlng);
                    updateLocationInfo();
                    marker.openPopup();
                    
                    // Dibujar ruta si la ubicación del usuario está disponible
                    if (userMarker) {
                        drawRoute();
                    }
                });
                
                // Marcar como cargado con éxito
                mapLoaded = true;
                
            } catch (error) {
                console.error("Error al inicializar el mapa:", error);
                handleMapError();
            }
        }
        
        // Update message on the marker
        function updateMessage() {
            try {
                if (mapLoaded && marker && popup) {
                    const message = document.getElementById('message').value;
                    popup.setContent('<div class="message-text">' + message + '</div>');
                    marker.openPopup();
                    
                    // Mostrar mensaje de confirmación
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.textContent = 'Mensaje actualizado';
                    statusMessage.className = 'status-message success';
                    
                    // Ocultar mensaje después de unos segundos
                    setTimeout(() => {
                        statusMessage.className = 'status-message';
                    }, 2000);
                }
            } catch (error) {
                console.error("Error al actualizar mensaje:", error);
            }
        }
        
        // Update location information text
        function updateLocationInfo(routeDistance) {
            try {
                const lat = currentPosition[0].toFixed(6);
                const lng = currentPosition[1].toFixed(6);
                
                let infoText = `Ubicación: ${lat}, ${lng}`;
                
                // Calcular distancia desde la ubicación del usuario si es diferente
                if (userPosition[0] !== currentPosition[0] || userPosition[1] !== currentPosition[1]) {
                    const lineDistance = calculateDistance(userPosition, currentPosition);
                    
                    if (routeDistance) {
                        infoText += `<br>Distancia por carretera: ${routeDistance} km`;
                        infoText += `<br>Distancia en línea recta: ${lineDistance.toFixed(2)} km`;
                    } else {
                        infoText += `<br>Distancia: ${lineDistance.toFixed(2)} km`;
                    }
                }
                
                document.getElementById('locationInfo').innerHTML = infoText;
            } catch (error) {
                console.error("Error al actualizar la información de ubicación:", error);
            }
        }
        
        // Calcular distancia entre dos puntos (en kilómetros)
        function calculateDistance(point1, point2) {
            try {
                // Convertir coordenadas a radianes
                const lat1 = point1[0] * Math.PI / 180;
                const lon1 = point1[1] * Math.PI / 180;
                const lat2 = point2[0] * Math.PI / 180;
                const lon2 = point2[1] * Math.PI / 180;
                
                // Radio de la Tierra en kilómetros
                const R = 6371;
                
                // Fórmula de Haversine
                const dLat = lat2 - lat1;
                const dLon = lon2 - lon1;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1) * Math.cos(lat2) * 
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const distance = R * c;
                
                return distance;
            } catch (error) {
                console.error("Error calculando distancia:", error);
                return 0;
            }
        }
        
       // Compartir a WhatsApp con enlaces limpios
function shareToWhatsApp() {
    try {
        const message = document.getElementById('message').value;
        const locationText = `Ubicación: ${currentPosition[0].toFixed(6)}, ${currentPosition[1].toFixed(6)}`;
        
        // URLs para compartir
        const googleMapsUrl = `https://www.google.com/maps?q=${currentPosition[0]},${currentPosition[1]}`;
        
        // Enlaces para direcciones desde la ubicación actual de quien recibe el mensaje
        const googleDirectionsFromCurrentLocation = `https://www.google.com/maps/dir/current+location/${currentPosition[0]},${currentPosition[1]}`;
        const leafletDirectionsUrl = `https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route=current;${currentPosition[0]}%2C${currentPosition[1]}#map=12/${currentPosition[0]}/${currentPosition[1]}`;
        
        // Mostrar mensaje de carga
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerHTML = '<div class="spinner"></div> Obteniendo instrucciones de ruta...';
        statusMessage.className = 'status-message loading';
        
        // Intenta obtener instrucciones de ruta
        const url = `https://graphhopper.com/api/1/route?point=${userPosition[0]},${userPosition[1]}&point=${currentPosition[0]},${currentPosition[1]}&vehicle=car&locale=es&instructions=true&calc_points=true&key=${GRAPHHOPPER_API_KEY}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                let routeInstructions = [];
                let distanceKm = "desconocida";
                let timeMinutes = "desconocido";
                
                // Extraer instrucciones si están disponibles
                if (data.paths && data.paths.length > 0) {
                    const path = data.paths[0];
                    
                    // Obtener distancia y tiempo
                    distanceKm = (path.distance / 1000).toFixed(2);
                    timeMinutes = Math.round(path.time / 60000); // convertir ms a minutos
                    
                    // Obtener instrucciones
                    if (path.instructions && path.instructions.length > 0) {
                        // Limitar a 5 instrucciones principales para no hacer el mensaje demasiado largo
                        const maxInstructions = Math.min(path.instructions.length, 5);
                        
                        for (let i = 0; i < maxInstructions; i++) {
                            const instruction = path.instructions[i];
                            let text = instruction.text;
                            
                            // Añadir distancia para cada instrucción
                            if (instruction.distance > 0) {
                                const dist = instruction.distance > 1000 
                                    ? (instruction.distance / 1000).toFixed(1) + ' km' 
                                    : Math.round(instruction.distance) + ' m';
                                text += ` (${dist})`;
                            }
                            
                            routeInstructions.push(text);
                        }
                        
                        // Si hay más instrucciones, indicarlo
                        if (path.instructions.length > maxInstructions) {
                            routeInstructions.push(`... y ${path.instructions.length - maxInstructions} indicaciones más`);
                        }
                    }
                }
                
                // Preparar texto para compartir
                let shareText = `*${message}*\n\n${locationText}`;
                
                // Añadir resumen de la ruta
                shareText += `\n\nDistancia aproximada: ${distanceKm} km`;
                if (timeMinutes !== "desconocido") {
                    shareText += `\nTiempo estimado: ${timeMinutes} min`;
                }
                
                // Añadir instrucciones de la ruta si están disponibles
                if (routeInstructions.length > 0) {
                    shareText += "\n\n*INSTRUCCIONES DE RUTA (referencia):*";
                    routeInstructions.forEach((instruction, index) => {
                        shareText += `\n${index + 1}. ${instruction}`;
                    });
                }
                
                // Añadir enlaces con textos personalizados para direcciones desde la ubicación de quien recibe
                shareText += `\n\n*Indicaciones desde tu ubicación actual:*`;
                shareText += `\n• [Ver ruta en Google Maps](${googleDirectionsFromCurrentLocation})`;
                shareText += `\n• [Ver ruta en OpenStreetMap](${leafletDirectionsUrl})`;
                
                // Añadir enlace para ver ubicación con texto personalizado
                shareText += `\n\n[Ver ubicación en el mapa](${googleMapsUrl})`;
                
                // Compartir a WhatsApp
                const encodedText = encodeURIComponent(shareText);
                
                // Detectar dispositivo móvil
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const whatsappURL = isMobile ? 
                    `whatsapp://send?text=${encodedText}` : 
                    `https://web.whatsapp.com/send?text=${encodedText}`;
                
                // Mostrar mensaje de éxito
                statusMessage.textContent = 'Abriendo WhatsApp...';
                statusMessage.className = 'status-message success';
                
                // Abrir WhatsApp después de mostrar el mensaje
                setTimeout(() => {
                    window.open(whatsappURL, '_blank');
                    
                    // Ocultar mensaje después de unos segundos
                    setTimeout(() => {
                        statusMessage.className = 'status-message';
                    }, 3000);
                }, 500);
            })
            .catch(error => {
                console.error("Error obteniendo instrucciones:", error);
                
                // En caso de error, compartir sin instrucciones detalladas
                shareWithoutInstructions();
            });
    } catch (error) {
        console.error("Error al compartir:", error);
        
        // En caso de error, compartir sin instrucciones detalladas
        shareWithoutInstructions();
    }
}

// Compartir sin instrucciones detalladas (fallback) con enlaces limpios
function shareWithoutInstructions() {
    try {
        const message = document.getElementById('message').value;
        const locationText = `Ubicación: ${currentPosition[0].toFixed(6)}, ${currentPosition[1].toFixed(6)}`;
        
        // URLs para compartir
        const googleMapsUrl = `https://www.google.com/maps?q=${currentPosition[0]},${currentPosition[1]}`;
        
        // Enlaces para direcciones desde la ubicación actual de quien recibe el mensaje
        const googleDirectionsFromCurrentLocation = `https://www.google.com/maps/dir/current+location/${currentPosition[0]},${currentPosition[1]}`;
        const leafletDirectionsUrl = `https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route=current;${currentPosition[0]}%2C${currentPosition[1]}#map=12/${currentPosition[0]}/${currentPosition[1]}`;
        
        // Calcular distancia
        const distance = calculateDistance(userPosition, currentPosition);
        const distanceText = !isNaN(distance) ? `\n\nDistancia aproximada: ${distance.toFixed(2)} km` : '';
        
        // Texto para compartir
        let shareText = `*${message}*\n\n${locationText}${distanceText}`;
        
        // Añadir enlaces para indicaciones desde la ubicación de quien recibe con texto personalizado
        shareText += `\n\n*Indicaciones desde tu ubicación actual:*`;
        shareText += `\n• [Ver ruta en Google Maps](${googleDirectionsFromCurrentLocation})`;
        shareText += `\n• [Ver ruta en OpenStreetMap](${leafletDirectionsUrl})`;
        
        // Añadir enlace para ver ubicación con texto personalizado
        shareText += `\n\n[Ver ubicación en el mapa](${googleMapsUrl})`;
        
        // Compartir a WhatsApp
        const encodedText = encodeURIComponent(shareText);
        
        // Detectar dispositivo móvil
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const whatsappURL = isMobile ? 
            `whatsapp://send?text=${encodedText}` : 
            `https://web.whatsapp.com/send?text=${encodedText}`;
        
        // Mostrar mensaje de éxito
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = 'Abriendo WhatsApp...';
        statusMessage.className = 'status-message success';
        
        // Abrir WhatsApp después de mostrar el mensaje
        setTimeout(() => {
            window.open(whatsappURL, '_blank');
            
            // Ocultar mensaje después de unos segundos
            setTimeout(() => {
                statusMessage.className = 'status-message';
            }, 3000);
        }, 500);
        
    } catch (error) {
        console.error("Error en el fallback:", error);
        
        // Mostrar mensaje de error
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = 'Error al compartir. Intenta de nuevo.';
        statusMessage.className = 'status-message error';
    }
}
// Función para capturar el mapa y compartir como imagen
// Función para capturar el mapa y compartir como imagen (versión corregida)
function captureAndShareMapImage() {
    try {
        // Mostrar mensaje de carga
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerHTML = '<div class="spinner"></div> Capturando mapa...';
        statusMessage.className = 'status-message loading';
        
        // Asegurarse de que el popup está abierto
        if (marker && popup) {
            marker.openPopup();
        }
        
        // Asegurarse de que la ruta es visible si existe
        if (routeLine) {
            routeLine.bringToFront();
        }
        
        // Pequeño retraso para asegurar que todo está renderizado
        setTimeout(() => {
            // Capturar el mapa usando html2canvas
            html2canvas(document.getElementById('map'), {
                useCORS: true,
                allowTaint: true,
                logging: true,
                backgroundColor: null
            }).then(canvas => {
                try {
                    // Convertir canvas a imagen
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Crear un elemento de imagen para mostrar la captura
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.style.width = '100%';
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.marginBottom = '10px';
                    img.alt = 'Mapa capturado';
                    
                    // Crear un contenedor para la imagen y botones
                    const captureContainer = document.createElement('div');
                    captureContainer.style.marginTop = '20px';
                    captureContainer.style.display = 'flex';
                    captureContainer.style.flexDirection = 'column';
                    captureContainer.style.gap = '10px';
                    captureContainer.id = 'captureContainer';
                    
                    // Título del contenedor
                    const title = document.createElement('h3');
                    title.textContent = 'Captura del mapa:';
                    captureContainer.appendChild(title);
                    
                    // Agregar imagen al contenedor
                    captureContainer.appendChild(img);
                    
                    // Botones para descargar o compartir
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.gap = '10px';
                    
                    // Botón para descargar
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Descargar imagen';
                    downloadBtn.className = 'download-btn';
                    downloadBtn.style.flex = '1';
                    downloadBtn.style.padding = '12px';
                    downloadBtn.style.backgroundColor = '#4CAF50';
                    downloadBtn.style.color = 'white';
                    downloadBtn.style.border = 'none';
                    downloadBtn.style.borderRadius = '4px';
                    downloadBtn.style.cursor = 'pointer';
                    downloadBtn.style.fontWeight = 'bold';
                    
                    // Evento para descargar
                    downloadBtn.onclick = function() {
                        const link = document.createElement('a');
                        link.download = `ubicacion_${Date.now()}.png`;
                        link.href = imgData;
                        link.click();
                    };
                    
                    buttonContainer.appendChild(downloadBtn);
                    
                    // Verificar si se puede compartir
                    if (navigator.share) {
                        const shareBtn = document.createElement('button');
                        shareBtn.textContent = 'Compartir imagen';
                        shareBtn.className = 'share-btn';
                        shareBtn.style.flex = '1';
                        shareBtn.style.padding = '12px';
                        shareBtn.style.backgroundColor = '#25D366';
                        shareBtn.style.color = 'white';
                        shareBtn.style.border = 'none';
                        shareBtn.style.borderRadius = '4px';
                        shareBtn.style.cursor = 'pointer';
                        shareBtn.style.fontWeight = 'bold';
                        
                        // Evento para compartir
                        shareBtn.onclick = function() {
                            try {
                                // Verificar si podemos compartir archivos
                                canvas.toBlob(function(blob) {
                                    const message = document.getElementById('message').value;
                                    const locationText = `Ubicación: ${currentPosition[0].toFixed(6)}, ${currentPosition[1].toFixed(6)}`;
                                    const shareText = `${message}\n\n${locationText}`;
                                    
                                    // Crear un archivo a partir del blob
                                    const file = new File([blob], "mapa.png", { type: "image/png" });
                                    
                                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                        navigator.share({
                                            text: shareText,
                                            files: [file]
                                        }).then(() => {
                                            statusMessage.textContent = '¡Imagen compartida con éxito!';
                                            statusMessage.className = 'status-message success';
                                        }).catch(error => {
                                            console.error("Error al compartir:", error);
                                            statusMessage.textContent = 'Error al compartir. Intenta descargar la imagen.';
                                            statusMessage.className = 'status-message error';
                                        });
                                    } else {
                                        // Si no podemos compartir archivos, compartimos solo el texto
                                        navigator.share({
                                            text: shareText
                                        }).then(() => {
                                            statusMessage.textContent = 'Mensaje compartido. Descarga la imagen para compartirla.';
                                            statusMessage.className = 'status-message success';
                                        }).catch(error => {
                                            console.error("Error al compartir texto:", error);
                                        });
                                    }
                                }, 'image/png');
                            } catch (error) {
                                console.error("Error al preparar para compartir:", error);
                                statusMessage.textContent = 'Error al compartir. Intenta descargar la imagen.';
                                statusMessage.className = 'status-message error';
                            }
                        };
                        
                        buttonContainer.appendChild(shareBtn);
                    }
                    
                    captureContainer.appendChild(buttonContainer);
                    
                    // Eliminar contenedor anterior si existe
                    const oldContainer = document.getElementById('captureContainer');
                    if (oldContainer) {
                        oldContainer.remove();
                    }
                    
                    // Agregar el contenedor a la página
                    const mainContainer = document.querySelector('.container');
                    mainContainer.appendChild(captureContainer);
                    
                    // Desplazar a la imagen
                    captureContainer.scrollIntoView({ behavior: 'smooth' });
                    
                    // Actualizar mensaje de estado
                    statusMessage.textContent = 'Mapa capturado con éxito';
                    statusMessage.className = 'status-message success';
                    
                    // Ocultar mensaje después de unos segundos
                    setTimeout(() => {
                        statusMessage.className = 'status-message';
                    }, 3000);
                    
                } catch (error) {
                    console.error("Error procesando la imagen:", error);
                    statusMessage.textContent = 'Error al procesar la imagen. Intenta de nuevo.';
                    statusMessage.className = 'status-message error';
                }
            }).catch(error => {
                console.error("Error capturando el mapa:", error);
                statusMessage.textContent = 'Error al capturar el mapa. Intenta de nuevo.';
                statusMessage.className = 'status-message error';
            });
        }, 500);
    } catch (error) {
        console.error("Error en la captura:", error);
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = 'Error al procesar la imagen. Intenta de nuevo.';
        statusMessage.className = 'status-message error';
    }
}

// Función auxiliar para convertir Data URI a Blob
function dataURItoBlob(dataURI) {
    // Convertir base64 a raw binary data
    const byteString = atob(dataURI.split(',')[1]);
    
    // Separar el tipo de contenido
    const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    
    // Escribir los bytes de la cadena a un ArrayBuffer
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    
    // Crear un blob con el ArrayBuffer
    return new Blob([ab], { type: mimeString });
}
    </script>
</body>
</html>